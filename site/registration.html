<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Регистрация - Bike App</title>

  <!-- Шрифты -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.41.0/dist/umd/supabase.min.js" defer></script>
  <script src="transitions.js" defer></script>

  <!-- IMask.js для масок ввода -->
  <script src="https://unpkg.com/imask"></script>

  <!-- ОСНОВНЫЕ СТИЛИ И СТИЛИ ФОРМЫ -->
  <style>
    :root{
      --primary-green:#29e29a;--dark-green:#083830;--icon-green:#26b999;
      --light-green-bg:#e0f8f1;--card-bg:#f0fdf9;--white:#ffffff;
      --border-color:#eaf0f0;--text-secondary:#a0b5b1;--danger-color:#e53e3e;
      --app-top-offset: calc(10px + var(--tg-content-safe-area-inset-top, var(--tg-safe-area-inset-top, 0px)));
      --safe-bottom: var(--tg-content-safe-area-inset-bottom, var(--tg-safe-area-inset-bottom, env(safe-area-inset-bottom, 0px)));
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html{height:100%}
    body{
      font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;
      background-color:var(--tg-theme-bg-color, #ffffff);
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100%;
      padding:var(--app-top-offset) 10px 0;
      overflow-x:hidden
    }
    .app-screen{width:100%;max-width:420px;background-color:var(--tg-theme-secondary-bg-color, var(--white));border-radius:25px;box-shadow:0 10px 40px rgba(0,0,0,.1);height:calc(var(--tg-viewport-stable-height, 100vh) - calc(10px + var(--tg-content-safe-area-inset-top, var(--tg-safe-area-inset-top, env(safe-area-inset-top, 0px)))));display:flex;flex-direction:column;overflow:hidden;margin:0 auto}
    .app-content{flex-grow:1;display:flex;flex-direction:column;padding:28px;gap:20px;overflow-x:hidden}
    .app-header{text-align:center;margin-bottom:10px}
    .app-header h1,.app-header h2{font-size:2.2rem;font-weight:700;color:var(--dark-green);line-height:1.2}
    .app-main{display:flex;flex-direction:column;flex-grow:1}
    form{display:flex;flex-direction:column;gap:20px;margin-top:25px}
    .form-group{position:relative}
    .form-group label{display:block;font-size:.9rem;font-weight:600;color:var(--dark-green);margin-bottom:8px}
    input[type=text],input[type=tel]{
      width:100%;padding:16px;background-color:var(--card-bg);border:2px solid var(--card-bg);
      border-radius:16px;font-size:1rem;color:var(--dark-green);transition:all .2s ease
    }
    input::placeholder{color:var(--text-secondary)}
    input:focus{outline:0;border-color:var(--icon-green);background-color:var(--white)}
    input.error{border-color:var(--danger-color)!important}
    .btn{border-radius:18px;font-weight:700;cursor:pointer;border:none;transition:all .2s;padding:18px 10px;font-size:1.1rem;width:100%}
    .btn-primary{background-color:var(--dark-green);color:var(--white)}
    .btn:disabled{background-color:#ccc;cursor:not-allowed}
    .validation-message{color:var(--danger-color);font-size:.9rem;text-align:center;margin-top:10px;display:none;font-weight:500}
    .hidden{display:none!important}
    #verify-overlay{
      position:fixed;inset:0;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:100
    }
    #verify-overlay .modal-content{
      background-color:#fff;border-radius:24px;padding:30px;width:90%;max-width:420px;max-height:90vh;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,.15)
    }
    #verify-overlay h3{margin-bottom:20px;font-size:1.4rem;font-weight:700;color:var(--dark-green)}
    .modal-actions{display:flex;gap:10px;justify-content:space-between;margin-top:20px}
    .investor-link-container{text-align:center;margin-top:auto;padding-top:20px}
    #investor-link{font-size:.9rem;color:var(--text-secondary);font-weight:500;cursor:pointer;background:none;text-decoration:none;border:1px solid var(--text-secondary);border-radius:8px;padding:4px 12px}
    .back-link{font-size:.9rem;color:var(--text-secondary);font-weight:600;text-decoration:none;cursor:pointer;background:none;border:none;align-self:center;margin-top:20px}
    
    /* ===== СТИЛИ ДЛЯ КРАСИВОЙ ФОРМЫ РЕГИСТРАЦИИ ===== */
    .form-hint { font-size: 0.85rem; color: #556f6b; margin-top: -5px; margin-bottom: 5px; }
    select.form-control {
        width: 100%; padding: 16px; background-color: var(--card-bg); border: 2px solid var(--card-bg);
        border-radius: 16px; font-size: 1rem; color: var(--dark-green); font-family: 'Inter', sans-serif;
        transition: all 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23083830' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat; background-position: right 16px center; background-size: 1.2em; cursor: pointer;
    }
    select.form-control:focus { outline: none; border-color: var(--icon-green); background-color: var(--white); }
    .file-upload-wrapper { position: relative; display: flex; align-items: center; width: 100%; }
    .file-upload-label { display: inline-block; padding: 10px 16px; background-color: var(--icon-green); color: var(--white);
        border-radius: 12px; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; flex-shrink: 0; }
    .file-upload-label:hover { background-color: var(--dark-green); }
    .file-upload-input { display: none; }
    .file-name { margin-left: 15px; color: #556f6b; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .custom-checkbox { display: flex; align-items: center; cursor: pointer; user-select: none; }
    .custom-checkbox input[type="checkbox"] { display: none; }
    .custom-checkbox .checkbox-visual { display: inline-block; width: 22px; height: 22px; background-color: var(--card-bg);
        border: 2px solid var(--card-bg); border-radius: 6px; margin-right: 12px; position: relative;
        transition: all 0.2s ease; flex-shrink: 0; }
    .custom-checkbox .checkbox-visual::after { content: ''; position: absolute; top: 2px; left: 6px; width: 6px; height: 12px;
        border: solid var(--white); border-width: 0 3px 3px 0; transform: rotate(45deg); opacity: 0; transition: opacity 0.2s ease; }
    .custom-checkbox input[type="checkbox"]:checked + .checkbox-visual { background-color: var(--icon-green); border-color: var(--icon-green); }
    .custom-checkbox input[type="checkbox"]:checked + .checkbox-visual::after { opacity: 1; }
    .form-separator { text-align: center; color: #a0b5b1; font-weight: 500; margin: 20px 0 10px;
        border: 0; border-top: 1px solid #eaf0f0; }
    .form-separator p { background: var(--white); padding: 0 10px; transform: translateY(-50%); display: inline-block; }

    /* --- Стили ТОЛЬКО для полноэкранных страниц, как регистрация --- */

    /* Убираем внешние отступы у body */
    body.fullscreen-form {
        padding: 0;
        align-items: stretch; /* Растягиваем контейнер на всю высоту */
    }

    /* Растягиваем сам контейнер и убираем рамки/тень */
    body.fullscreen-form .app-screen {
        max-width: 100%;
        height: 100vh;
        border-radius: 0;
        box-shadow: none;

        /* Важно: возвращаем верхний отступ внутрь контейнера,
           чтобы сам контент не лез под "челку" телефона */
        padding-top: var(--app-top-offset);
    }
  </style>
</head>
<body class="fullscreen-form">
<div class="app-screen">
  <div class="app-content">
    <header class="app-header">
      <h1 id="main-title">Регистрация</h1>
      <h2 id="investor-title" class="hidden">Для инвесторов</h2>
    </header>

    <main class="app-main">
      <!-- ===== ОСНОВНАЯ РЕГИСТРАЦИЯ ===== -->
      <div id="registration-view">
        <form id="registration-form" novalidate>
            <!-- Блок 1: Основная информация -->
            <div class="form-group">
                <label for="name">Ваше имя (как в документе)</label>
                <input type="text" id="name" placeholder="Иван Иванов" required />
            </div>
            <div class="form-group">
                <label for="phone">Номер телефона</label>
                <input type="tel" id="phone" placeholder="+7 (___) ___-__-__" required />
            </div>
            <div class="form-group">
                <label for="birth-date">Дата рождения</label>
                <input type="tel" id="birth-date" placeholder="ДД.ММ.ГГГГ" required />
            </div>
            <div class="form-group">
                <label for="city-select">Город работы</label>
                <select id="city-select" class="form-control" required>
                    <option value="" disabled selected>Выберите город</option>
                    <option value="Москва">Москва</option>
                    <option value="Санкт-Петербург">Санкт-Петербург</option>
                </select>
            </div>
            <div class="form-group">
                <label for="country-select">Страна гражданства</label>
                <select id="country-select" class="form-control" required>
                    <option value="" disabled selected>Выберите страну</option>
                    <option value="ru">Российская Федерация</option>
                    <option value="kz">Казахстан</option>
                    <option value="kg">Кыргызстан</option>
                    <option value="uz">Узбекистан</option>
                    <option value="tj">Таджикистан</option>
                    <option value="other">Другое</option>
                </select>
            </div>

            <!-- Блок 2: Документы для граждан РФ -->
            <div id="russian-fields" class="hidden">
                <div class="form-group">
                    <label>Фото паспорта (главный разворот)</label>
                    <div class="file-upload-wrapper">
                        <label for="ru-passport-main" class="file-upload-label">Выберите файл</label>
                        <input type="file" id="ru-passport-main" class="file-upload-input" accept="image/*,application/pdf" />
                        <span id="ru-passport-main-filename" class="file-name">Файл не выбран</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Фото паспорта (страница с регистрацией)</label>
                    <div class="file-upload-wrapper">
                        <label for="ru-passport-reg" class="file-upload-label">Выберите файл</label>
                        <input type="file" id="ru-passport-reg" class="file-upload-input" accept="image/*,application/pdf" />
                        <span id="ru-passport-reg-filename" class="file-name">Файл не выбран</span>
                    </div>
                </div>
                <div class="form-group">
                     <label for="no-registration-checkbox" class="custom-checkbox">
                        <input type="checkbox" id="no-registration-checkbox" />
                        <span class="checkbox-visual"></span>
                        <span>У меня нет штампа о регистрации в паспорте</span>
                    </label>
                </div>
                <div class="form-group">
                     <label for="ru-inn">ИНН (12 цифр)</label>
                     <input type="tel" id="ru-inn" placeholder="1234 567890" />
                 </div>
            </div>

            <!-- Блок 3: Документы для иностранных граждан -->
            <div id="foreign-fields" class="hidden">
                <div class="form-group">
                    <label>Фото основного документа</label>
                    <p class="form-hint">Загранпаспорт (главная страница) или ID-карта (лицевая сторона).</p>
                    <div class="file-upload-wrapper">
                        <label for="foreign-passport-front" class="file-upload-label">Выберите файл</label>
                        <input type="file" id="foreign-passport-front" class="file-upload-input" accept="image/*,application/pdf" />
                        <span id="foreign-passport-front-filename" class="file-name">Файл не выбран</span>
                    </div>
                </div>
                <div class="form-group" id="foreign-passport-back-group">
                    <label>Фото документа (оборотная сторона)</label>
                    <p class="form-hint">Только для ID-карт.</p>
                    <div class="file-upload-wrapper">
                        <label for="foreign-passport-back" class="file-upload-label">Выберите файл</label>
                        <input type="file" id="foreign-passport-back" class="file-upload-input" accept="image/*,application/pdf" />
                        <span id="foreign-passport-back-filename" class="file-name">Файл не выбран</span>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="foreign-inn">ИНН РФ (если есть)</label>
                    <input type="tel" id="foreign-inn" placeholder="Введите ваш ИНН" />
                </div>
            </div>
            
            <!-- Блок 4: Патент для граждан не из ЕАЭС -->
            <div id="patent-fields" class="hidden">
                <div class="form-separator"><p>Следующие поля необязательны</p></div>
                <div class="form-group">
                    <label>Патент на работу (лицевая сторона)</label>
                    <div class="file-upload-wrapper">
                        <label for="patent-front" class="file-upload-label">Выберите файл</label>
                        <input type="file" id="patent-front" class="file-upload-input" accept="image/*,application/pdf" />
                        <span id="patent-front-filename" class="file-name">Файл не выбран</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Патент на работу (оборотная сторона)</label>
                    <div class="file-upload-wrapper">
                        <label for="patent-back" class="file-upload-label">Выберите файл</label>
                        <input type="file" id="patent-back" class="file-upload-input" accept="image/*,application/pdf" />
                        <span id="patent-back-filename" class="file-name">Файл не выбран</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Чек об оплате патента</label>
                    <div class="file-upload-wrapper">
                        <label for="patent-receipt" class="file-upload-label">Выберите файл</label>
                        <input type="file" id="patent-receipt" class="file-upload-input" accept="image/*,application/pdf" />
                        <span id="patent-receipt-filename" class="file-name">Файл не выбран</span>
                    </div>
                </div>
            </div>

            <!-- Опциональные поля в конце -->
            <div class="form-separator"><p>Дополнительные документы (необязательно)</p></div>

            <div class="form-group">
                <label>Водительское удостоверение</label>
                <div class="file-upload-wrapper">
                    <label for="drivers-license-file" class="file-upload-label">Выберите файл</label>
                    <input type="file" id="drivers-license-file" class="file-upload-input" accept="image/*,application/pdf" />
                    <span id="drivers-license-file-filename" class="file-name">Файл не выбран</span>
                </div>
            </div>

            <div class="form-group">
                <label for="emergency-contact-phone">Телефон экстренного контакта</label>
                <input type="tel" id="emergency-contact-phone" placeholder="+7 (___) ___-__-__" />
            </div>

            <div id="reg-validation-error" class="validation-message"></div>
            <button type="submit" id="reg-submit-btn" class="btn btn-primary" style="margin-top: 15px;">Далее</button>
        </form>

        <div class="investor-link-container" style="text-align: center; margin-top: auto; padding-top: 20px;">
          <a href="recover.html" class="back-link" style="font-size: 0.9rem; color: var(--text-secondary); text-decoration: none;">Не можете войти?</a>
        </div>
      </div>

      <!-- ===== ФОРМА ИНВЕСТОРА ===== -->
      <div id="investor-view" class="hidden">
        <form id="investor-form" novalidate>
          <div class="form-group">
            <label for="investor-name">ФИО</label>
            <input type="text" id="investor-name" placeholder="Полное имя" required />
          </div>
          <div class="form-group">
            <label for="investor-inn">ИНН</label>
            <input type="tel" id="investor-inn" placeholder="12 цифр" required />
          </div>
          <div class="form-group">
            <label for="investor-passport">Паспортные данные</label>
            <input type="tel" id="investor-passport" placeholder="Серия и номер" required />
          </div>

          <div id="investor-validation-error" class="validation-message"></div>
          <button type="submit" id="investor-submit-btn" class="btn btn-primary">Отправить данные</button>
        </form>
        <button id="back-to-reg-link" class="back-link">Назад к регистрации</button>
      </div>
    </main>
  </div>
</div>

<!-- Оверлей: подтверждение распознанных данных -->
<div id="verify-overlay" class="hidden">
  <div class="modal-content">
    <h3>Проверьте данные паспорта</h3>
    <form id="verify-form"></form>
    <div class="modal-actions">
      <button type="button" id="verify-cancel" class="btn btn-secondary">Назад</button>
      <button type="button" id="verify-confirm" class="btn btn-primary">Подтвердить</button>
    </div>
  </div>
</div>

<!-- Основная логика -->
<script type="module">
  import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
  
  // ===== КОНФИГ =====
  const SUPABASE_URL = "https://avamqfmuhiwtlumjkzmv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2YW1xZm11aGl3dGx1bWprem12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NjMyODcsImV4cCI6MjA3MjIzOTI4N30.EwEPM0pObAd3v_NXI89DLcgKVYrUiOn7iHuCXXaqU4I";
  const GEMINI_API_KEY = "AIzaSyAUay_xvRT_gcMYs3-7i8Pcli680Or5Zwk";

  // ===== ИНИЦИАЛИЗАЦИЯ =====
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

  // ===== ЭЛЕМЕНТЫ =====
  const registrationForm = document.getElementById("registration-form");
  const submitBtn = document.getElementById("reg-submit-btn");
  const nameInput = document.getElementById("name");
  const phoneInput = document.getElementById("phone");

  const verifyOverlay = document.getElementById("verify-overlay");
  const verifyForm = document.getElementById("verify-form");
  const verifyCancelBtn = document.getElementById("verify-cancel");
  const verifyConfirmBtn = document.getElementById("verify-confirm");

  const investorView = document.getElementById("investor-view");
  const registrationView = document.getElementById("registration-view");
  const mainTitle = document.getElementById("main-title");
  const investorTitle = document.getElementById("investor-title");
  const investorLink = document.getElementById("investor-link");
  const backToRegLink = document.getElementById("back-to-reg-link");
  const investorForm = document.getElementById("investor-form");
  
  const countrySelect = document.getElementById('country-select');
  const russianFields = document.getElementById('russian-fields');
  const foreignFields = document.getElementById('foreign-fields');
  const patentFields = document.getElementById('patent-fields');
  const noRegistrationCheckbox = document.getElementById('no-registration-checkbox');

  let pendingRegistrationData = null;

  // ===== УТИЛИТЫ =====
  const requiredError = (id, msg) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg || "Пожалуйста, заполните все обязательные поля.";
    el.style.display = "block";
  };
  const hideError = (id) => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  };
  const validateRequired = (form, errorId) => {
    hideError(errorId);
    let ok = true;
    form.querySelectorAll("input[required], select[required]").forEach((input) => {
      input.classList.remove("error");
      if (!String(input.value || "").trim()) {
        input.classList.add("error");
        ok = false;
      }
    });
    if (!ok) requiredError(errorId);
    return ok;
  };
  function toggleButtonLoading(btn, isLoading, textIdle, textBusy) {
    btn.disabled = !!isLoading;
    btn.textContent = isLoading ? textBusy : textIdle;
  }
  async function fileToGenerativePart(file) {
    const base64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(String(reader.result).split(",")[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    return { inlineData: { data: base64, mimeType: file.type || "image/jpeg" } };
  }
  function tryParseJSON(text) {
    let cleaned = text.replace(/```json/gi, "").replace(/```/g, "").trim();
    try { return JSON.parse(cleaned); } catch {}
    const match = cleaned.match(/\{[\s\S]*\}/);
    if (match) { try { return JSON.parse(match[0]); } catch {} }
    return null;
  }
  function buildVerifyForm(data) {
    verifyForm.innerHTML = "";
    const longFieldKeys = new Set(["Кем выдан", "Адрес регистрации", "Место рождения"]);
    Object.keys(data).forEach((key) => {
      const value = data[key] ?? "";
      const id = `verify_${key.replace(/\s+/g, "_")}`;
      const input = longFieldKeys.has(key)
        ? `<textarea id="${id}" name="${key}" rows="3">${String(value)}</textarea>`
        : `<input type="text" id="${id}" name="${key}" value="${String(value)}" />`;
      verifyForm.insertAdjacentHTML("beforeend", `<div class="form-group"><label for="${id}">${key}</label>${input}</div>`);
    });
  }

  // ===== ЛОГИКА ФОРМЫ =====
  document.querySelectorAll('.file-upload-input').forEach(input => {
    const fileNameSpan = document.getElementById(`${input.id}-filename`);
    if (fileNameSpan) {
        input.addEventListener('change', () => {
            fileNameSpan.textContent = input.files[0] ? input.files[0].name : 'Файл не выбран';
        });
    }
  });

  // Обработчик для водительского удостоверения
  const driversLicenseFileInput = document.getElementById('drivers-license-file');
  if (driversLicenseFileInput) {
      driversLicenseFileInput.addEventListener('change', function() {
          const fileNameSpan = document.getElementById('drivers-license-file-filename');
          if (fileNameSpan) {
              fileNameSpan.textContent = this.files[0] ? this.files[0].name : 'Файл не выбран';
          }
      });
  }

  // Форматирование телефона экстренного контакта
  const emergencyContactPhoneInput = document.getElementById('emergency-contact-phone');
  if (emergencyContactPhoneInput) {
  }

  function toggleFields(showIds = [], hideIds = []) {
    showIds.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
    hideIds.forEach(id => document.getElementById(id)?.classList.add('hidden'));
  }

  countrySelect.addEventListener('change', (e) => {
    const country = e.target.value;
    const allInputs = registrationForm.querySelectorAll('input, select');
    allInputs.forEach(i => i.required = false); // Сбрасываем required у всех

    // Восстанавливаем required для базовых полей
    if (nameInput) nameInput.required = true;
    if (phoneInput) phoneInput.required = true;
    const citySelect = document.getElementById('city-select');
    if (citySelect) citySelect.required = true;
    if (countrySelect) countrySelect.required = true;
    
    switch (country) {
        case 'ru':
            toggleFields(['russian-fields'], ['foreign-fields', 'patent-fields']);
            document.getElementById('ru-passport-main').required = true;
            document.getElementById('ru-passport-reg').required = !noRegistrationCheckbox.checked;
            document.getElementById('ru-inn').required = true;
            break;
        case 'kz': case 'kg':
            toggleFields(['foreign-fields'], ['russian-fields', 'patent-fields']);
            document.getElementById('foreign-passport-front').required = true;
            break;
        case 'uz': case 'tj': case 'other':
            toggleFields(['foreign-fields', 'patent-fields'], ['russian-fields']);
            document.getElementById('foreign-passport-front').required = true;
            break;
        default:
            toggleFields([], ['russian-fields', 'foreign-fields', 'patent-fields']);
            break;
    }
  });
  
  noRegistrationCheckbox.addEventListener('change', () => {
    if (countrySelect.value === 'ru') {
        const regInput = document.getElementById('ru-passport-reg');
        regInput.required = !noRegistrationCheckbox.checked;
        if (noRegistrationCheckbox.checked) {
            regInput.closest('.file-upload-wrapper').classList.remove('error');
        }
    }
  });
  
  // ===== ГЛАВНЫЙ ФЛОУ РЕГИСТРАЦИИ =====
  registrationForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!validateRequired(registrationForm, "reg-validation-error")) return;

    // --- УМНЫЙ СБОР ФОТОГРАФИЙ ДЛЯ GEMINI ---
    const photosForGemini = [];
    const mainPhotoInput = document.getElementById(countrySelect.value === 'ru' ? 'ru-passport-main' : 'foreign-passport-front');
    const regPhotoInput = document.getElementById('ru-passport-reg');

    if (mainPhotoInput && mainPhotoInput.files[0]) {
        photosForGemini.push(mainPhotoInput.files[0]);
    }
    // Добавляем фото прописки только если это паспорт РФ и галочка не стоит
    if (countrySelect.value === 'ru' && regPhotoInput && regPhotoInput.files[0] && !noRegistrationCheckbox.checked) {
        photosForGemini.push(regPhotoInput.files[0]);
    }
    
    let currentData = { recognizedData: null };

    if (photosForGemini.length > 0) {
        toggleButtonLoading(submitBtn, true, "Далее", "Анализируем документы...");
        try {
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-lite" });
            const prompt = "Ты — система верификации документов. Извлеки из этих изображений паспорта данные в формате JSON: Фамилия, Имя, Отчество, Серия паспорта, Номер паспорта, Дата рождения, Место рождения, Кем выдан, Дата выдачи, Код подразделения, Адрес регистрации. Если каких-то данных нет, оставь поле пустым. Ответь строго JSON без пояснений.";
            
            // Превращаем все собранные файлы в нужный для Gemini формат
            const imageParts = await Promise.all(photosForGemini.map(file => fileToGenerativePart(file)));
            
            const result = await model.generateContent([prompt, ...imageParts]);
            const text = await result.response.text();
            const parsed = tryParseJSON(text);

            if (parsed && typeof parsed === "object") {
                currentData.recognizedData = parsed;
                pendingRegistrationData = currentData;
                buildVerifyForm(parsed);
                verifyOverlay.classList.remove('hidden');
            } else {
                // Если распознать не удалось, продолжаем без данных
                await finalizeRegistration(currentData);
            }
        } catch (err) {
            console.error("Ошибка распознавания Gemini:", err);
            alert('Не удалось распознать документы. Вы можете заполнить их вручную позже. Продолжаем регистрацию.');
            await finalizeRegistration(currentData); // Продолжаем регистрацию даже если Gemini выдал ошибку
        } finally {
            toggleButtonLoading(submitBtn, false, "Далее", "Анализируем документы...");
        }
    } else {
        // Если фото не прикрепили (хотя поля обязательны), просто идем дальше
        await finalizeRegistration(currentData);
    }
});

  verifyConfirmBtn.addEventListener("click", async () => {
    if (!pendingRegistrationData) {
      verifyOverlay.classList.add("hidden");
      return;
    }
    const updatedRecognizedData = {};
    new FormData(verifyForm).forEach((value, key) => { updatedRecognizedData[key] = value; });
    pendingRegistrationData.recognizedData = updatedRecognizedData;
    verifyOverlay.classList.add("hidden");
    await finalizeRegistration(pendingRegistrationData);
  });
  
  verifyCancelBtn.addEventListener("click", () => { verifyOverlay.classList.add("hidden"); });
  
  // ФУНКЦИЯ СОХРАНЕНИЯ В SUPABASE
  async function finalizeRegistration(regData) {
      toggleButtonLoading(submitBtn, true, "Далее", "Сохраняем данные...");
      try {
          const name = nameInput?.value?.trim() || '';
          const phone = phoneInput?.value?.trim() || '';
          const city = document.getElementById('city-select')?.value || '';
          const citizenship = document.getElementById('country-select')?.value || '';
          const emergencyContactPhone = document.getElementById('emergency-contact-phone')?.value?.trim() || '';
          const filesToUpload = [
              { id: 'ru-passport-main', description: 'ru_passport_main' },
              { id: 'ru-passport-reg', description: 'ru_passport_reg' },
              { id: 'foreign-passport-front', description: 'foreign_passport_front' },
              { id: 'foreign-passport-back', description: 'foreign_passport_back' },
              { id: 'patent-front', description: 'patent_front' },
              { id: 'patent-back', description: 'patent_back' },
              { id: 'patent-receipt', description: 'patent_receipt' },
              { id: 'drivers-license-file', description: 'drivers_license' }
          ].map(f => ({ file: document.getElementById(f.id)?.files?.[0], description: f.description })).filter(f => f.file);
          const extraData = {
              citizenship: citizenship, city: city,
              emergency_contact_phone: emergencyContactPhone,
              recognized_data: regData.recognizedData || {}, migrant_info: {}
          };
          if (citizenship === 'ru') {
              extraData.inn = document.getElementById('ru-inn').value.trim();
              extraData.has_no_registration_stamp = document.getElementById('no-registration-checkbox').checked;
          } else {
              extraData.inn = document.getElementById('foreign-inn').value.trim();
              if (['uz', 'tj', 'other'].includes(citizenship)) {
                  extraData.migrant_info.has_patent_front = !!document.getElementById('patent-front').files.length;
                  extraData.migrant_info.has_patent_back = !!document.getElementById('patent-back').files.length;
                  extraData.migrant_info.has_patent_receipt = !!document.getElementById('patent-receipt').files.length;
              }
          }
          const { data: clientData, error: clientError } = await supabase
              .from("clients").insert([{ name: name, phone: phone, city: city, extra: extraData }]).select().single();
          if (clientError) {
              if (clientError.message.includes('duplicate key value violates unique constraint "clients_phone_key"')) {
                  throw new Error("Пользователь с таким номером телефона уже зарегистрирован.");
              }
              throw clientError;
          }
          const newUserId = clientData.id;
          const uploadPromises = filesToUpload.map(async ({ file, description }) => {
              const fileExt = file.name.split('.').pop();
              const fileName = `${Date.now()}_${description}.${fileExt}`;
              const filePath = `${newUserId}/${fileName}`;
              const { error: uploadError } = await supabase.storage.from('passports').upload(filePath, file);
              if (uploadError) console.warn(`Не удалось загрузить файл ${description}:`, uploadError);
          });
          await Promise.all(uploadPromises);
          localStorage.setItem("isRegistered", "true");
          localStorage.setItem("userName", clientData.name);
          localStorage.setItem("userId", newUserId);
          window.location.replace("index.html");
      } catch (err) {
          console.error("Финальная ошибка регистрации:", err);
          requiredError("reg-validation-error", `Ошибка: ${err.message}`);
      } finally {
          toggleButtonLoading(submitBtn, false, "Далее", "Сохраняем данные...");
      }
  }

  // ===== INVESTOR VIEW & MASKS =====
  // Обработчики для инвестора (элементы могут отсутствовать)
  const investorLinkEl = document.getElementById("investor-link");
  if (investorLinkEl) {
    investorLinkEl.addEventListener("click", () => {
      registrationView.classList.add("hidden");
      mainTitle.classList.add("hidden");
      investorView.classList.remove("hidden");
      investorTitle.classList.remove("hidden");
    });
  }

  if (backToRegLink) {
    backToRegLink.addEventListener("click", () => {
      investorView.classList.add("hidden");
      investorTitle.classList.add("hidden");
      registrationView.classList.remove("hidden");
      mainTitle.classList.remove("hidden");
    });
  }

  // ===== МАСКИ ВВОДА (IMask.js) =====
  // Применяем маски только к существующим элементам
  const applyMasks = () => {
    // Настройки для всех телефонов
    const phoneMaskOptions = {
      mask: '+7 (000) 000-00-00'
    };

    const phoneEl = document.getElementById('phone');
    if (phoneEl) IMask(phoneEl, phoneMaskOptions);

    const emergencyPhoneEl = document.getElementById('emergency-contact-phone');
    if (emergencyPhoneEl) IMask(emergencyPhoneEl, phoneMaskOptions);

    // Маска для даты рождения
    const birthDateEl = document.getElementById('birth-date');
    if (birthDateEl) {
        IMask(birthDateEl, {
            mask: '00.00.0000'
        });
    }

    // Настройки для всех ИНН (12 цифр)
    const innMaskOptions = {
      mask: '0000 000000'
    };

    const ruInnEl = document.getElementById('ru-inn');
    if (ruInnEl) IMask(ruInnEl, innMaskOptions);

    const foreignInnEl = document.getElementById('foreign-inn');
    if (foreignInnEl) IMask(foreignInnEl, innMaskOptions);

    // Настройки для ИНН инвестора (12 цифр)
    const investorInnEl = document.getElementById('investor-inn');
    if (investorInnEl) IMask(investorInnEl, innMaskOptions);

    // Настройки для паспорта инвестора (серия и номер)
    const investorPassportEl = document.getElementById('investor-passport');
    if (investorPassportEl) {
      IMask(investorPassportEl, {
        mask: '0000 000000'
      });
    }
  };

  // Применяем маски после загрузки DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyMasks);
  } else {
    applyMasks();
  }
  investorForm.addEventListener("submit", (event) => {
      event.preventDefault();
      if (!validateRequired(investorForm, "investor-validation-error")) return;
      const investorSubmitBtn = document.getElementById("investor-submit-btn");
      toggleButtonLoading(investorSubmitBtn, true, "Отправить данные", "Создание аккаунта...");
      setTimeout(() => {
        localStorage.setItem("isRegistered", "true");
        localStorage.setItem("isInvestor", "true");
        localStorage.setItem("userName", (document.getElementById("investor-name").value || "").trim().split(" ")[0] || "Инвестор");
        window.location.replace("investor_home.html");
      }, 800);
  });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Проверяем, что API Telegram доступен
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            
            // Эта команда говорит Telegram, что цвет шапки должен совпадать с фоном нашего приложения
            tg.setHeaderColor('bg_color'); 
        }
    });
</script>
</body>
</html>
